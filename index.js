// G≈Ç√≥wny plik aplikacji
const { Client, GatewayIntentBits, Collection, InteractionType, ModalBuilder, TextInputBuilder, ActionRowBuilder, TextInputStyle, StringSelectMenuBuilder, ButtonBuilder, ButtonStyle, MessageFlags } = require('discord.js');
const fs = require('fs');
const path = require('path');
require('dotenv').config({ path: path.join(__dirname, '.env') });
const { MAX_CONCURRENT_FORMS } = require('./utils/raportDataStore');
const logger = require('./utils/logger');
const { validateTime } = require('./utils/timeValidation');
const { formatDiscordError } = require('./utils/errorHandler');
const { getDisplayName } = require('./utils/helpers');

const VERSION = '1.0.0';

// Wywo≈Çanie bannera startowego na poczƒÖtku
logger.drawStartupBanner(VERSION);
logger.logConfig(process.env);

// Inicjalizacja klienta Discord z odpowiednimi uprawnieniami
const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.GuildMembers
    ]
});

// Kolekcja do przechowywania komend
client.commands = new Collection();

// ≈Åadowanie komend z folderu commands
const commandsPath = path.join(__dirname, 'commands');
console.log('\nüìö ≈Åadowanie komend:');
const commandFiles = fs.readdirSync(commandsPath).filter(file => file.endsWith('.js'));

// Dodaj import store'a
const raportStore = require('./utils/raportDataStore');

// Dodaj import funkcji wyslijRaport
const { wyslijRaport, formatujRaport } = require('./commands/raport');
const googleSheets = require('./utils/googleSheets');
const ChannelManager = require('./utils/channelManager');

for (const file of commandFiles) {
    const filePath = path.join(commandsPath, file);
    const command = require(filePath);
    client.commands.set(command.data.name, command);
    console.log(`‚îú‚îÄ ${command.data.name} ‚úÖ`);
}
console.log('‚îî‚îÄ Za≈Çadowano wszystkie komendy\n');

// Obs≈Çuga eventu ready
client.once('ready', () => {
    console.log(`
ü§ñ Bot gotowy do pracy:
‚îú‚îÄ Nazwa:    ${client.user.tag}
‚îú‚îÄ ID:       ${client.user.id}
‚îú‚îÄ Serwery:  ${client.guilds.cache.size}
‚îî‚îÄ Status:   Online
`);

    // Poka≈º poczƒÖtkowe statystyki
    console.log(`
üìä Statystyki poczƒÖtkowe:
‚îú‚îÄ Uptime:             0d 0h 0m
‚îú‚îÄ U≈ºyto komend:       0
‚îú‚îÄ Utworzono raport√≥w: 0
‚îî‚îÄ Aktywne formularze: 0/${MAX_CONCURRENT_FORMS}
`);
});

// Dodajemy okresowe czyszczenie nieaktywnych formularzy
setInterval(() => {
    raportStore.cleanupStaleReports();
}, 5 * 60 * 1000); // Co 5 minut

// Statystyki
const stats = {
    commandsUsed: 0,
    reportsCreated: 0,
    startTime: Date.now()
};

// Funkcja do formatowania uptime
function getUptime() {
    const uptime = Date.now() - stats.startTime;
    const days = Math.floor(uptime / (1000 * 60 * 60 * 24));
    const hours = Math.floor((uptime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
    return `${days}d ${hours}h ${minutes}m`;
}

// Wy≈õwietlanie statystyk co godzinƒô
setInterval(() => {
    console.log(`
üìä Statystyki:
‚îú‚îÄ Uptime:           ${getUptime()}
‚îú‚îÄ U≈ºyto komend:     ${stats.commandsUsed}
‚îú‚îÄ Utworzono raport√≥w: ${stats.reportsCreated}
‚îî‚îÄ Aktywne formularze: ${raportStore.size}/${MAX_CONCURRENT_FORMS}
`);
}, 60 * 60 * 1000);

// Obs≈Çuga interakcji (komendy slash)
client.on('interactionCreate', async interaction => {
    try {
        if (interaction.isChatInputCommand()) {
            console.log(`üë§ [BOT] ${interaction.user.username} u≈ºy≈Ç /${interaction.commandName}`);
            stats.commandsUsed++;
            const command = client.commands.get(interaction.commandName);
            if (!command) return;
            const displayName = getDisplayName(interaction.user);
            await command.execute(interaction);
        } 
        else if (interaction.type === InteractionType.MessageComponent) {
            const customId = interaction.customId;

            // Obs≈Çuga przycisku reset
            if (customId === 'reset_form') {
                // Wymuszamy reset
                raportStore.resetReport(interaction.user.id);

                await interaction.update({
                    content: 'Formularz zosta≈Ç zresetowany. Mo≈ºesz teraz u≈ºyƒá komendy /raport aby rozpoczƒÖƒá od nowa.',
                    components: [],
                    flags: [MessageFlags.Ephemeral]
                });
                return;
            }

            const userData = raportStore.getReport(interaction.user.id);

            if (!userData) {
                await interaction.reply({
                    content: 'Sesja wygas≈Ça. U≈ºyj komendy /raport ponownie.',
                    flags: [MessageFlags.Ephemeral]
                });
                return;
            }

            let updateData = {};

            // Obs≈Çuga wyboru miejsca pracy, auta, os√≥b i kierowcy
            if (customId === 'miejsce_pracy' || customId === 'auto' || 
                customId === 'osoby_pracujace' || customId === 'kierowca') {
                
                // Aktualizuj odpowiednie pole
                if (customId === 'miejsce_pracy') {
                    updateData.miejscePracy = interaction.values[0];
                } else if (customId === 'auto') {
                    updateData.auto = interaction.values[0];
                } else if (customId === 'osoby_pracujace') {
                    updateData.osobyPracujace = interaction.values;
                } else if (customId === 'kierowca') {
                    updateData.kierowca = interaction.values[0];
                }

                // Aktualizuj dane w store
                const updatedData = raportStore.updateReport(interaction.user.id, updateData);
                
                // Aktualizuj wiadomo≈õƒá pokazujƒÖc ca≈Çy stan formularza
                await interaction.update({
                    content: `**Stan formularza:**\n
üìç Miejsce pracy: ${updatedData.miejscePracy || 'nie wybrano'}
üöó Auto: ${updatedData.auto || 'nie wybrano'}
üë• Osoby pracujƒÖce: ${updatedData.osobyPracujace?.length ? updatedData.osobyPracujace.join(', ') : 'nie wybrano'}
üßë‚Äç‚úàÔ∏è Kierowca: ${updatedData.kierowca || 'nie wybrano'}
üí∞ Dieta: ${updatedData.dieta === undefined ? 'nie wybrano' : updatedData.dieta ? 'Tak' : 'Nie'}`,
                    components: interaction.message.components.map(row => {
                        const component = row.components[0];
                        if (component.data.custom_id === customId) {
                            component.data.placeholder = `‚úÖ Wybrano: ${interaction.values[0]}`;
                        }
                        return row;
                    }),
                    flags: [MessageFlags.Ephemeral]
                });
            }
            // Obs≈Çuga wyboru diety
            else if (customId.startsWith('dieta_')) {
                updateData.dieta = customId === 'dieta_tak';
                const updatedData = raportStore.updateReport(interaction.user.id, updateData);
                
                await interaction.update({
                    content: `**Stan formularza:**\n
üìç Miejsce pracy: ${updatedData.miejscePracy || 'nie wybrano'}
üöó Auto: ${updatedData.auto || 'nie wybrano'}
üë• Osoby pracujƒÖce: ${updatedData.osobyPracujace?.length ? updatedData.osobyPracujace.join(', ') : 'nie wybrano'}
üßë‚Äç‚úàÔ∏è Kierowca: ${updatedData.kierowca || 'nie wybrano'}
üí∞ Dieta: ${updatedData.dieta === undefined ? 'nie wybrano' : updatedData.dieta ? 'Tak' : 'Nie'}`,
                    components: interaction.message.components.map(row => {
                        // Je≈õli to rzƒÖd z przyciskami diety
                        if (row.components[0] instanceof ButtonBuilder || 
                            row.components[0].data.type === 2) { // 2 to typ dla przycisk√≥w
                            return new ActionRowBuilder()
                                .addComponents(
                                    new ButtonBuilder()
                                        .setCustomId('dieta_tak')
                                        .setLabel(updatedData.dieta ? '‚úÖ Dieta: Tak' : 'Dieta: Tak')
                                        .setStyle(updatedData.dieta ? ButtonStyle.Success : ButtonStyle.Secondary),
                                    new ButtonBuilder()
                                        .setCustomId('dieta_nie')
                                        .setLabel(!updatedData.dieta ? '‚úÖ Dieta: Nie' : 'Dieta: Nie')
                                        .setStyle(!updatedData.dieta ? ButtonStyle.Danger : ButtonStyle.Secondary)
                                );
                        }
                        return row;
                    }),
                    flags: [MessageFlags.Ephemeral]
                });
            }
            // Obs≈Çuga wyboru daty i czasu
            else if (customId === 'data_raportu' || 
                     customId === 'godzina_rozpoczecia' || 
                     customId === 'minuta_rozpoczecia' ||
                     customId === 'godzina_zakonczenia' || 
                     customId === 'minuta_zakonczenia') {
                
                const timeData = raportStore.getReport(interaction.user.id);
                const selectedValue = interaction.values[0];

                // Aktualizuj odpowiednie pola w zale≈ºno≈õci od typu wyboru
                if (customId === 'data_raportu') {
                    timeData.selectedDate = selectedValue;
                } 
                else if (customId === 'godzina_rozpoczecia') {
                    timeData.startHour = selectedValue;
                }
                else if (customId === 'minuta_rozpoczecia') {
                    timeData.startMinute = selectedValue;
                }
                else if (customId === 'godzina_zakonczenia') {
                    timeData.endHour = selectedValue;
                }
                else if (customId === 'minuta_zakonczenia') {
                    timeData.endMinute = selectedValue;
                }

                // Je≈õli mamy wszystkie potrzebne dane, sformatuj czas
                if (timeData.selectedDate) {
                    // Logujemy datƒô tylko je≈õli siƒô zmieni≈Ça
                    if (timeData.selectedDate !== userData.selectedDate) {
                        console.log(`üìù [RAPORT] ${userData.username} aktualizuje: data: ${timeData.selectedDate}`);
                    }
                    
                    if (timeData.startHour && timeData.startMinute) {
                        timeData.czasRozpoczecia = `${timeData.selectedDate} ${timeData.startHour}:${timeData.startMinute}`;
                        // Logujemy tylko je≈õli czas siƒô zmieni≈Ç
                        if (timeData.czasRozpoczecia !== userData.czasRozpoczecia) {
                            console.log(`üìù [RAPORT] ${userData.username} aktualizuje: czas rozpoczƒôcia: ${timeData.startHour}:${timeData.startMinute}`);
                        }
                    }
                    if (timeData.endHour && timeData.endMinute) {
                        timeData.czasZakonczenia = `${timeData.selectedDate} ${timeData.endHour}:${timeData.endMinute}`;
                        console.log(`üìù [RAPORT] ${userData.username} aktualizuje: czas zako≈Ñczenia: ${timeData.endHour}:${timeData.endMinute}`);
                    }
                }

                // Dodaƒá walidacjƒô gdy mamy kompletne czasy
                if (timeData.startHour && timeData.startMinute && 
                    timeData.endHour && timeData.endMinute) {
                    
                    const timeValidation = validateTime(
                        `${timeData.startHour}:${timeData.startMinute}`,
                        `${timeData.endHour}:${timeData.endMinute}`
                    );

                    if (!timeValidation.valid) {
                        await interaction.update({
                            content: `
‚ö†Ô∏è **B≈ÅƒÑD WALIDACJI CZASU!** ‚ö†Ô∏è
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ùå ${timeValidation.message}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
                            components: interaction.message.components,
                            flags: [MessageFlags.Ephemeral]
                        });
                        return;
                    }
                }

                // Aktualizuj store u≈ºywajƒÖc istniejƒÖcej metody updateReport
                const updatedData = raportStore.updateReport(interaction.user.id, timeData);

                // Sprawd≈∫ czy formularz jest kompletny po aktualizacji czasu
                if (updatedData.miejscePracy && 
                    updatedData.auto && 
                    updatedData.osobyPracujace.length > 0 && 
                    updatedData.kierowca &&
                    typeof updatedData.dieta !== 'undefined' &&
                    updatedData.czasRozpoczecia && 
                    updatedData.czasZakonczenia) {
                    
                    // Sprawd≈∫ czy istnieje raport z tƒÖ samƒÖ datƒÖ
                    const istniejacyRaport = await googleSheets.znajdzRaportUzytkownika(
                        updatedData.username.toLowerCase().replace(/ /g, '_'),
                        updatedData.selectedDate
                    );

                    if (istniejacyRaport) {
                        console.log(`üìù [RAPORT] Znaleziono istniejƒÖcy raport dla ${updatedData.username} z dnia ${updatedData.selectedDate}`);
                    }

                    const buttons = [
                        new ButtonBuilder()
                            .setCustomId('wyslij_raport')
                            .setLabel('‚úÖ Wy≈õlij jako nowy')
                            .setStyle(ButtonStyle.Success)
                    ];

                    if (istniejacyRaport) {
                        console.log('Znaleziono istniejƒÖcy raport, dodajƒô przycisk podmiany');
                        buttons.push(
                            new ButtonBuilder()
                                .setCustomId('podmien_raport')
                                .setLabel('üîÑ Podmie≈Ñ istniejƒÖcy')
                                .setStyle(ButtonStyle.Primary)
                        );
                    }

                    buttons.push(
                        new ButtonBuilder()
                            .setCustomId('anuluj_raport')
                            .setLabel('‚ùå Anuluj')
                            .setStyle(ButtonStyle.Danger)
                    );

                    const confirmationButtons = new ActionRowBuilder().addComponents(buttons);

                    await interaction.update({
                        content: `**Podsumowanie raportu:**\n
üë∑‚Äç‚ôÇÔ∏è Pracownik: ${updatedData.username}
üìç Miejsce pracy: ${updatedData.miejscePracy}
‚è∞ Czas pracy: ${updatedData.czasRozpoczecia} - ${updatedData.czasZakonczenia}
üí∞ Dieta / Delegacja: ${updatedData.dieta ? 'Tak' : 'Nie'}
üë• Osoby pracujƒÖce: ${updatedData.osobyPracujace.join(', ')}
üöó Auto: ${updatedData.auto}
üßë‚Äç‚úàÔ∏è Kierowca: ${updatedData.kierowca}

Czy chcesz wys≈Çaƒá raport?`,
                        components: [confirmationButtons],
                        flags: [MessageFlags.Ephemeral]
                    });
                } else {
                    // Poka≈º tylko aktualizacjƒô czasu
                    await interaction.update({
                        content: `**Wybrane parametry czasu:**\n
üìÖ Data: ${updatedData.selectedDate || 'nie wybrano'}
‚è∞ Czas rozpoczƒôcia: ${updatedData.czasRozpoczecia ? updatedData.czasRozpoczecia.split(' ')[1] : 'nie wybrano'}
‚è∞ Czas zako≈Ñczenia: ${updatedData.czasZakonczenia ? updatedData.czasZakonczenia.split(' ')[1] : 'nie wybrano'}`,
                        components: interaction.message.components.map(row => {
                            const component = row.components[0];
                            if (component.data.custom_id === customId) {
                                component.data.placeholder = `‚úÖ Wybrano: ${interaction.values[0]}`;
                            }
                            return row;
                        }),
                        flags: [MessageFlags.Ephemeral]
                    });
                }
            }

            // Obs≈Çuga przycisk√≥w potwierdzenia
            else if (customId === 'wyslij_raport' || customId === 'podmien_raport' || customId === 'anuluj_raport') {
                if (customId === 'wyslij_raport') {
                    const currentData = raportStore.getReport(interaction.user.id);
                    const timeSpent = Math.round((Date.now() - currentData.startTime) / 1000);
                    console.log(`‚è±Ô∏è [RAPORT] Czas wype≈Çniania: ${timeSpent}s`);
                    
                    currentData.pracownik = currentData.username;
                    
                    try {
                        // Najpierw odpowiedz na interakcjƒô
                        await interaction.update({
                            content: 'Wysy≈Çanie raportu...',
                            components: [], // Usu≈Ñ przyciski
                            flags: [MessageFlags.Ephemeral]
                        });

                        const displayName = getDisplayName(interaction.user);
                        await wyslijRaport(interaction, currentData);
                        stats.reportsCreated++;
                        raportStore.deleteReport(interaction.user.id);
                        
                        // Podsumowanie wys≈Çanego raportu
                        console.log(`
‚ú® [RAPORT] Wys≈Çano raport:
‚îú‚îÄ Autor:     ${currentData.username}
‚îú‚îÄ Data:      ${currentData.selectedDate}
‚îú‚îÄ Godziny:   ${currentData.czasRozpoczecia.split(' ')[1]} - ${currentData.czasZakonczenia.split(' ')[1]}
‚îú‚îÄ Miejsce:   ${currentData.miejscePracy}
‚îú‚îÄ Auto:      ${currentData.auto}
‚îú‚îÄ Kierowca:  ${currentData.kierowca}
‚îú‚îÄ Osoby:     ${currentData.osobyPracujace.join(', ')}
‚îî‚îÄ Dieta:     ${currentData.dieta ? 'Tak' : 'Nie'}
`);

                        // Teraz mo≈ºemy u≈ºyƒá followUp
                        await interaction.followUp({
                            content: 'Raport zosta≈Ç pomy≈õlnie wys≈Çany!',
                            flags: [MessageFlags.Ephemeral]
                        });
                    } catch (error) {
                        console.error('B≈ÇƒÖd podczas wysy≈Çania raportu:', error);
                        await interaction.followUp({
                            content: `
‚ö†Ô∏è **B≈ÅƒÑD!** ‚ö†Ô∏è
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${formatDiscordError(error)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
                            flags: [MessageFlags.Ephemeral]
                        });
                    }
                } else if (customId === 'podmien_raport') {
                    try {
                        const currentData = raportStore.getReport(interaction.user.id);
                        const timeSpent = Math.round((Date.now() - currentData.startTime) / 1000);
                        console.log(`‚è±Ô∏è [RAPORT] Czas wype≈Çniania: ${timeSpent}s`);
                        
                        currentData.pracownik = currentData.username;

                        // Najpierw odpowiadamy na interakcjƒô, ≈ºeby Discord nie zg≈Çasza≈Ç b≈Çƒôdu
                        await interaction.deferUpdate();
                        
                        // Znajd≈∫ istniejƒÖce raporty
                        const istniejaceRaporty = await googleSheets.znajdzRaportyUzytkownika(
                            currentData.username.toLowerCase().replace(/ /g, '_'),
                            currentData.selectedDate
                        );

                        if (istniejaceRaporty.length > 1) {
                            console.log(`
üìù [RAPORT] Znaleziono wiele raport√≥w:
‚îú‚îÄ U≈ºytkownik: ${currentData.username}
‚îú‚îÄ Data: ${currentData.selectedDate}
‚îî‚îÄ Liczba: ${istniejaceRaporty.length} raport√≥w`);
                            
                            // Tworzymy przyciski wyboru dla ka≈ºdego raportu
                            const buttons = istniejaceRaporty.map((raport, index) => {
                                const czasStart = raport[3].split(' ')[1];
                                const czasKoniec = raport[4].split(' ')[1];
                                const miejscePracy = raport[2];
                                return new ButtonBuilder()
                                    .setCustomId(`wybierz_raport_${index}`)
                                    .setLabel(`${index + 1}. ${miejscePracy} (${czasStart}-${czasKoniec})`)
                                    .setStyle(ButtonStyle.Primary);
                            });

                            // Dodajemy przycisk anulowania
                            buttons.push(
                                new ButtonBuilder()
                                    .setCustomId('anuluj_wybor_raportu')
                                    .setLabel('0. ‚ùå Anuluj wyb√≥r')
                                    .setStyle(ButtonStyle.Danger)
                            );

                            // Dzielimy przyciski na rzƒôdy (max 5 przycisk√≥w na rzƒÖd)
                            const rows = [];
                            for (let i = 0; i < buttons.length; i += 5) {
                                rows.push(
                                    new ActionRowBuilder().addComponents(buttons.slice(i, i + 5))
                                );
                            }

                            // Aktualizujemy oryginalnƒÖ wiadomo≈õƒá
                            await interaction.editReply({
                                content: `
üìù **Znaleziono ${istniejaceRaporty.length} raporty z dnia ${currentData.selectedDate}**

Wybierz, kt√≥ry raport chcesz zaktualizowaƒá:

${istniejaceRaporty.map((raport, index) => {
    const czasStart = raport[3].split(' ')[1];
    const czasKoniec = raport[4].split(' ')[1];
    const miejscePracy = raport[2];
    return `**${index + 1}. ${miejscePracy}**
‚è∞ ${czasStart}-${czasKoniec}`;
}).join('\n\n')}

‚ö†Ô∏è Wybrany raport zostanie przeniesiony do historii i zastƒÖpiony nowym.
‚ùå Wybierz "0. Anuluj wyb√≥r" aby przerwaƒá edycjƒô.`,
                                components: rows,
                                flags: [MessageFlags.Ephemeral]
                            });

                        } else if (istniejaceRaporty.length === 1) {
                            // IstniejƒÖca logika dla pojedynczego raportu
                            await googleSheets.przeniesDoHistorii(istniejaceRaporty[0]);
                            await wyslijRaport(interaction, currentData, true, istniejaceRaporty[0]);
                            raportStore.deleteReport(interaction.user.id);
                            
                            // Podsumowanie edytowanego raportu
                            console.log(`
üîÑ [RAPORT] Edytowano raport:
‚îú‚îÄ Autor:     ${currentData.username}
‚îú‚îÄ Data:      ${currentData.selectedDate}
‚îú‚îÄ Godziny:   ${currentData.czasRozpoczecia.split(' ')[1]} - ${currentData.czasZakonczenia.split(' ')[1]}
‚îú‚îÄ Miejsce:   ${currentData.miejscePracy}
‚îú‚îÄ Auto:      ${currentData.auto}
‚îú‚îÄ Kierowca:  ${currentData.kierowca}
‚îú‚îÄ Osoby:     ${currentData.osobyPracujace.join(', ')}
‚îî‚îÄ Dieta:     ${currentData.dieta ? 'Tak' : 'Nie'}
`);
                            
                            await interaction.editReply({
                                content: 'Raport zosta≈Ç pomy≈õlnie zaktualizowany!',
                                components: [],
                                flags: [MessageFlags.Ephemeral]
                            });
                        } else {
                            console.log(`‚ùå [RAPORT] Nie znaleziono raportu do aktualizacji dla ${currentData.username}`);
                            await interaction.editReply({
                                content: 'Nie znaleziono raportu do aktualizacji.',
                                components: [],
                                flags: [MessageFlags.Ephemeral]
                            });
                        }
                    } catch (error) {
                        console.error(`‚ùå [INDEX] ${formatDiscordError(error)}`);
                        if (!interaction.deferred) {
                            await interaction.deferUpdate();
                        }
                        await interaction.followUp({
                            content: formatDiscordError(error),
                            flags: [MessageFlags.Ephemeral]
                        });
                    }
                } else {
                    // Anuluj raport
                    raportStore.deleteReport(interaction.user.id);
                    console.log(`‚ùå [RAPORT] ${interaction.user.username} anulowa≈Ç raport`);
                    
                    await interaction.update({
                        content: 'Raport anulowany. U≈ºyj komendy /raport aby rozpoczƒÖƒá od nowa.',
                        components: [], // Usu≈Ñ przyciski
                        flags: [MessageFlags.Ephemeral]
                    });
                }
            } else if (customId.startsWith('wybierz_raport_')) {
                const index = parseInt(customId.split('_').pop());
                const currentData = raportStore.getReport(interaction.user.id);
                const istniejaceRaporty = await googleSheets.znajdzRaportyUzytkownika(
                    currentData.username.toLowerCase().replace(/ /g, '_'),
                    currentData.selectedDate
                );

                if (istniejaceRaporty[index]) {
                    try {
                        await interaction.update({
                            content: 'Aktualizowanie wybranego raportu...',
                            components: [],
                            flags: [MessageFlags.Ephemeral]
                        });

                        await googleSheets.przeniesDoHistorii(istniejaceRaporty[index]);
                        await wyslijRaport(interaction, currentData, true, istniejaceRaporty[index]);
                        raportStore.deleteReport(interaction.user.id);

                        await interaction.followUp({
                            content: 'Raport zosta≈Ç pomy≈õlnie zaktualizowany!',
                            flags: [MessageFlags.Ephemeral]
                        });
                    } catch (error) {
                        console.error('‚ùå B≈ÇƒÖd podczas aktualizacji raportu:', error);
                        await interaction.followUp({
                            content: `
‚ö†Ô∏è **B≈ÅƒÑD!** ‚ö†Ô∏è
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${formatDiscordError(error)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
                            flags: [MessageFlags.Ephemeral]
                        });
                    }
                }
            } else if (customId === 'anuluj_wybor_raportu') {
                raportStore.deleteReport(interaction.user.id);
                await interaction.update({
                    content: 'Anulowano wyb√≥r raportu. U≈ºyj komendy /raport aby rozpoczƒÖƒá od nowa.',
                    components: [],
                    flags: [MessageFlags.Ephemeral]
                });
            }
        }
    } catch (error) {
        console.error(`‚ùå [BOT] B≈ÇƒÖd: ${error.message}`);
        await interaction.reply({
            content: 'WystƒÖpi≈Ç b≈ÇƒÖd podczas wykonywania tej komendy!',
            flags: [MessageFlags.Ephemeral]
        });
    }
});

// Dodaj wiƒôcej log√≥w debugowania
client.on('ready', () => {
    console.log(`Zalogowano jako ${client.user.tag}`);
});

client.on('error', (error) => {
    console.error('Discord client error:', error);
});

process.on('unhandledRejection', (error) => {
    console.error('Unhandled promise rejection:', error);
});

// Logowanie bota
console.log('üîë Logowanie do Discord...');
client.login(process.env.TOKEN).catch(error => {
    console.error('‚ùå B≈ÇƒÖd logowania:', error.message);
});

// Obs≈Çuga graceful shutdown
process.on('SIGINT', () => {
    console.log(`
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üõë Bot ko≈Ñczy pracƒô...
‚îú‚îÄ Uptime:             ${getUptime()}
‚îú‚îÄ U≈ºyto komend:       ${stats.commandsUsed}
‚îú‚îÄ Utworzono raport√≥w: ${stats.reportsCreated}
‚îî‚îÄ Aktywne formularze: ${raportStore.size}/${MAX_CONCURRENT_FORMS}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`);
    process.exit(0);
}); 